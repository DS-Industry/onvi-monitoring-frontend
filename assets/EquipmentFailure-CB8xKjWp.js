import{d as Re,b as Ee,r as h,a2 as Oe,U as Ve,V as Fe,a5 as Me,Z as We,_ as Ke,q as Ye,t as He,v as g,ag as Le,w as Be,ah as ze,ai as Ae,aj as Ue,ak as Ge,al as Je,y as Qe,z as te,am as Ze,an as _e,j as s,D as $e,ao as ne,G as Xe,H as ea,J as aa,L as I,ap as M,aq as W,Q as ta,B as se,M as oe}from"./index-C24s9YLx.js";import{S as na}from"./NoEquipment-BCMrYMdq.js";import{F as sa}from"./FilterMonitoring-DnjDobpT.js";const ca=()=>{var J,Q,Z,_,$,X,ee;const{t:n}=Re(),ie=n("warehouse.all"),{buttonOn:re,setButtonOn:y}=Ee(),[l,K]=h.useState(!1),[Y,H]=h.useState(0),de=new Date().toISOString().slice(0,10),[le,L]=h.useState(!1),[B,ce]=h.useState(!1),me=Oe(),ue=Ve(),pe=Fe(),z=Me(),Ie=We(),he=Ke(),D=Ye(),ge=He(),ve={dateStart:ue.toString().slice(0,10)||"2024-01-01",dateEnd:pe.toString().slice(0,10)||`${de}`,posId:me||1,placementId:D},[x,fe]=h.useState(ve),De=e=>{fe(t=>({...t,...e})),L(!0),e.posId&&z(e.posId),e.dateStart&&Ie(new Date(e.dateStart)),e.dateEnd&&he(new Date(e.dateEnd)),e.placementId&&ge(e.placementId)},{data:C,isLoading:xe,mutate:A}=g(["get-incident"],()=>Le({dateStart:x.dateStart,dateEnd:x.dateEnd,posId:x.posId,placementId:D}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),U={posId:0,workerId:0,appearanceDate:"",startDate:"",finishDate:"",objectName:"",equipmentKnotId:void 0,incidentNameId:void 0,incidentReasonId:void 0,incidentSolutionId:void 0,downtime:2,comment:"",carWashDeviceProgramsTypeId:void 0},[a,T]=h.useState(U),{data:P,isLoading:we,isValidating:qe}=g(["get-pos",D],()=>Be({placementId:D}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:R}=g(["get-worker"],()=>ze(),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:E}=g(a.posId!==0?["get-device",a.posId]:null,()=>Ae(a.posId),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:v}=g(a.posId!==0?["get-equipment-knot",a.posId]:null,()=>Ue(a.posId),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:p}=g(v?["get-incident-equipment-knot"]:null,()=>Ge(v?v[0].props.id:0),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:O}=g(a.posId!==0?["get-all-programs",a.posId]:null,()=>Je({posId:a.posId}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),w=((P==null?void 0:P.map(e=>({name:e.name,value:e.id})))||[]).sort((e,t)=>e.name.localeCompare(t.name)),je={name:ie,value:"*"},V=((R==null?void 0:R.map(e=>({name:e.name,value:e.id})))||[]).sort((e,t)=>e.name.localeCompare(t.name)),F=a.posId===0?[]:((O==null?void 0:O.map(e=>({name:e.props.name,value:e.props.id})))||[]).sort((e,t)=>e.name.localeCompare(t.name)),q=(C==null?void 0:C.map(e=>{var t,m,c;return{...e,posName:((t=w.find(u=>u.value===e.posId))==null?void 0:t.name)||"-",workerName:((m=V.find(u=>u.value===e.workerId))==null?void 0:m.name)||"-",programName:((c=F.find(u=>u.value===e.programId))==null?void 0:c.name)||"-"}}).sort((e,t)=>e.id-t.id))||[];h.useEffect(()=>{A().then(()=>L(!1))},[x,A]);const G=a.posId===0?[]:((E==null?void 0:E.map(e=>({name:e.props.name,value:e.props.name})))||[]).sort((e,t)=>e.name.localeCompare(t.name)),j=a.posId===0?[]:((v==null?void 0:v.map(e=>({name:e.props.name,value:e.props.id})))||[]).sort((e,t)=>e.name.localeCompare(t.name)),S=a.posId===0?[]:((p==null?void 0:p.map(e=>({name:e.problemName,value:e.id})))||[]).sort((e,t)=>e.name.localeCompare(t.name)),N=a.posId===0?[]:((p==null?void 0:p.flatMap(e=>e.reason.map(t=>({name:t.infoName,value:t.id}))).filter((e,t,m)=>t===m.findIndex(c=>c.value===e.value)))||[]).sort((e,t)=>e.name.localeCompare(t.name)),b=a.posId===0?[]:((p==null?void 0:p.flatMap(e=>e.solution.map(t=>({name:t.infoName,value:t.id}))).filter((e,t,m)=>t===m.findIndex(c=>c.value===e.value)))||[]).sort((e,t)=>e.name.localeCompare(t.name)),{register:d,handleSubmit:Se,errors:i,setValue:Ne,reset:be}=Qe(a),{trigger:ke,isMutating:ye}=te(["create-incident"],async()=>Ze({posId:a.posId,workerId:a.workerId,appearanceDate:a.appearanceDate,startDate:a.startDate,finishDate:a.finishDate,objectName:a.objectName,equipmentKnotId:a.equipmentKnotId,incidentNameId:a.incidentNameId,incidentReasonId:a.incidentReasonId,incidentSolutionId:a.incidentSolutionId,downtime:a.downtime,comment:a.comment,carWashDeviceProgramsTypeId:a.carWashDeviceProgramsTypeId})),{trigger:Ce}=te(["update-incident"],async()=>_e({incidentId:Y,workerId:a.workerId,appearanceDate:a.appearanceDate,startDate:a.startDate,finishDate:a.finishDate,objectName:a.objectName,equipmentKnotId:a.equipmentKnotId,incidentNameId:a.incidentNameId,incidentReasonId:a.incidentReasonId,incidentSolutionId:a.incidentSolutionId,downtime:a.downtime,comment:a.comment,carWashDeviceProgramsTypeId:a.carWashDeviceProgramsTypeId})),r=(e,t)=>{const c=["downtime","posId","workerId","equipmentKnotId","incidentNameId","incidentReasonId","incidentSolutionId","carWashDeviceProgramsTypeId"].includes(e)?Number(t):t;T(u=>({...u,[e]:c})),Ne(e,t)},Te=e=>{var m,c,u,ae;H(e),K(!0),y(!0);const t=q.find(f=>f.id===e);if(t){const f=o=>new Date(o).toISOString().slice(0,16);T({posId:t.posId,workerId:t.workerId,appearanceDate:f(t.appearanceDate),startDate:f(t.startDate),finishDate:f(t.finishDate),objectName:t.objectName,equipmentKnotId:j.find(o=>o.name===t.equipmentKnot)?Number((m=j.find(o=>o.name===t.equipmentKnot))==null?void 0:m.value):0,incidentNameId:S.find(o=>o.name===t.equipmentKnot)?Number((c=S.find(o=>o.name===t.incidentName))==null?void 0:c.value):0,incidentReasonId:N.find(o=>o.name===t.equipmentKnot)?Number((u=N.find(o=>o.name===t.incidentReason))==null?void 0:u.value):0,incidentSolutionId:b.find(o=>o.name===t.equipmentKnot)?Number((ae=b.find(o=>o.name===t.incidentSolution))==null?void 0:ae.value):0,downtime:t.downtime==="Нет"?0:1,comment:t.comment,carWashDeviceProgramsTypeId:t.programId})}},k=()=>{T(U),K(!1),be(),H(0),y(!1)},Pe=async()=>{try{if(Y)if(await Ce())oe(["get-incident"]),k();else throw new Error("Invalid update data.");else if(await ke())oe(["get-incident"]),k();else throw new Error("Invalid response from API")}catch(e){console.error("Error during form submission: ",e)}};return s.jsxs(s.Fragment,{children:[s.jsx(sa,{count:q.length,posesSelect:[...w,je],handleDataFilter:De,hideSearch:!0,loadingPos:we||qe}),le||xe?s.jsx($e,{columnCount:ne.length}):q.length>0?s.jsx("div",{className:"mt-8",children:s.jsx(Xe,{data:q,columns:ne,isDisplayEdit:!0,onEdit:Te})}):s.jsx(ea,{title:n("equipment.nodata"),description:n("equipment.noBreakdown"),children:s.jsx("img",{src:na,className:"mx-auto",loading:"lazy",alt:"FAILURE"})}),s.jsx(aa,{onClose:k,children:s.jsxs("form",{className:"space-y-6",onSubmit:Se(Pe),children:[s.jsx("span",{className:"font-semibold text-xl md:text-3xl mb-5 text-text01",children:n("equipment.break")}),s.jsx(I,{title:n("equipment.carWash"),label:w.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:w,classname:"w-72",...d("posId",{required:!l&&"Pos ID is required",validate:e=>e!==0||l||"Pos ID is required"}),value:a.posId,onChange:e=>{r("posId",e),z(e)},error:!!i.posId,helperText:(J=i.posId)==null?void 0:J.message,isDisabled:l}),s.jsx(I,{title:n("equipment.employee"),label:V.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:V,classname:"w-72",...d("workerId",{required:!l&&"Worker ID is required",validate:e=>e!==0||l||"Worker ID is required"}),value:a.workerId,onChange:e=>r("workerId",e),error:!!i.workerId,helperText:(Q=i.workerId)==null?void 0:Q.message}),s.jsx(M,{title:n("equipment.call"),classname:"w-64",value:a.appearanceDate?W(a.appearanceDate):null,changeValue:e=>r("appearanceDate",e?e.format("YYYY-MM-DDTHH:mm"):""),error:!!i.appearanceDate,...d("appearanceDate",{required:!l&&"Appearance Date is required"}),helperText:((Z=i.appearanceDate)==null?void 0:Z.message)||""}),s.jsx(M,{title:n("equipment.start"),classname:"w-64",value:a.startDate?W(a.startDate):null,changeValue:e=>r("startDate",e?e.format("YYYY-MM-DDTHH:mm"):""),error:!!i.startDate,...d("startDate",{required:!l&&"Start Date is required"}),helperText:((_=i.startDate)==null?void 0:_.message)||""}),s.jsx(M,{title:n("equipment.end"),classname:"w-64",value:a.finishDate?W(a.finishDate):null,changeValue:e=>r("finishDate",e?e.format("YYYY-MM-DDTHH:mm"):""),error:!!i.finishDate,...d("finishDate",{required:!l&&"Finish Date is required"}),helperText:(($=i.finishDate)==null?void 0:$.message)||""}),s.jsxs("div",{className:"flex",children:[s.jsx("input",{type:"checkbox",checked:B,onChange:e=>{ce(e.target.checked),r("objectName","Вся мойка")}}),s.jsx("div",{className:"text-text02 ml-2",children:n("equipment.whole")})]}),s.jsx(I,{title:n("equipment.device"),label:G.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:G,classname:"w-72",...d("objectName",{required:!l&&"Device is required"}),value:a.objectName,onChange:e=>r("objectName",e),error:!!i.objectName,helperText:(X=i.objectName)==null?void 0:X.message,isDisabled:B}),s.jsx(I,{title:n("equipment.knot"),label:j.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:j,classname:"w-72",...d("equipmentKnotId"),value:a.equipmentKnotId,onChange:e=>r("equipmentKnotId",e)}),s.jsx(I,{title:n("equipment.name"),label:S.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:S,classname:"w-72",...d("incidentNameId"),value:a.incidentNameId,onChange:e=>r("incidentNameId",e)}),s.jsx(I,{title:n("equipment.cause"),label:N.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:N,classname:"w-72",...d("incidentReasonId"),value:a.incidentReasonId,onChange:e=>r("incidentReasonId",e)}),s.jsx(I,{title:n("equipment.measures"),label:b.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:b,classname:"w-72",...d("incidentSolutionId"),value:a.incidentSolutionId,onChange:e=>r("incidentSolutionId",e)}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("div",{className:"text-text02 text-sm font-semibold",children:n("equipment.simple")}),s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsxs("label",{className:"flex items-center",children:[s.jsx("input",{type:"radio",value:1,checked:a.downtime===1,className:"mr-2",...d("downtime",{required:!l&&"Downtime is required"}),onChange:e=>r("downtime",e.target.value)}),n("equipment.yes")]}),s.jsxs("label",{className:"flex items-center",children:[s.jsx("input",{type:"radio",value:0,checked:a.downtime===0,...d("downtime",{required:!l&&"Downtime is required"}),onChange:e=>r("downtime",e.target.value),className:"mr-2"}),n("equipment.no")]})]}),i.downtime&&s.jsx("div",{className:"text-[11px] font-normal text-errorFill",children:"Downtime is required."})]}),s.jsx(I,{title:n("equipment.program"),label:F.length===0?n("warehouse.noVal"):n("warehouse.notSel"),options:F,classname:"w-72",...d("carWashDeviceProgramsTypeId"),value:a.carWashDeviceProgramsTypeId,onChange:e=>r("carWashDeviceProgramsTypeId",e)}),s.jsx(ta,{title:n("equipment.comment"),classname:"w-96",value:a.comment,changeValue:e=>r("comment",e.target.value),error:!!i.comment,...d("comment",{required:!l&&"Comment is required"}),helperText:((ee=i.comment)==null?void 0:ee.message)||""}),s.jsxs("div",{className:"flex justify-end space-x-4",children:[s.jsx(se,{title:n("organizations.cancel"),type:"outline",handleClick:()=>{y(!re),k()}}),s.jsx(se,{title:n("organizations.save"),form:!0,isLoading:ye,handleClick:()=>{}})]})]})})]})};export{ca as default};
