import{d as ge,f as fe,e as be,q as je,v as z,w as Te,ca as ke,r as i,y as Ie,z as b,cb as Se,cc as Ne,cd as we,ce as Ee,j as t,ap as Fe,aq as A,L as Me,B as v,D as K,F as j,cf as U,G as Oe,K as _}from"./index-C24s9YLx.js";import{O as Pe}from"./OverflowTable-BMnnkjZz.js";import{D as d}from"./index-DAyk0lNe.js";import{D as Re}from"./index-DcwOAMTp.js";const Be=()=>{var R,Y,q,L,V,B,H,W,$;const{t:a}=ge(),T=fe(),c=be(),F=je(),{data:k}=z(["get-pos",F],()=>Te({placementId:F}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:h}=z((R=c==null?void 0:c.state)!=null&&R.ownerId?["get-collection"]:null,()=>ke(c.state.ownerId),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),G=(k==null?void 0:k.map(e=>({name:e.name,value:e.id})))||[],J={posId:0,cashCollectionDate:""},[p,Q]=i.useState(J),{register:M,handleSubmit:X,errors:g,setValue:Z}=Ie(p),{trigger:ee,isMutating:I}=b(["post-collection"],async()=>Se({cashCollectionDate:new Date(p.cashCollectionDate),posId:p.posId})),{trigger:te,isMutating:se}=b((Y=c==null?void 0:c.state)!=null&&Y.ownerId?["return-collection"]:null,async()=>{var e;return Ne((e=c.state)==null?void 0:e.ownerId)}),O=(e,n)=>{const s=["posId"].includes(e)?Number(n):n;Q(u=>({...u,[e]:s})),Z(e,n)};i.useEffect(()=>{h&&Object.keys(h).length>0?(x(h.cashCollectionDeviceType),y(h.cashCollectionDevice),C(h)):(x([]),y([]),C({}))},[h]);const ne=async()=>{try{const e=await ee();if(e)x(e.cashCollectionDeviceType),y(e.cashCollectionDevice),C(e),re(!0);else throw new Error("Invalid update data.")}catch(e){console.error("Error during form submission: ",e)}},[r,x]=i.useState([]),[m,y]=i.useState([]),[o,C]=i.useState({}),[f,ae]=i.useState(!0),[le,S]=i.useState(null),[N,ce]=i.useState(!0),[w,oe]=i.useState(!0),[ie,re]=i.useState(!1),ue=e=>{S(e)},de=(e,n,l)=>{x(s=>s==null?void 0:s.map(u=>u.id===e?{...u,[n]:l}:u))},me=(e,n,l)=>{const s=e.target.value,u=new Date(s).toISOString();y(D=>D.map(E=>E.deviceId===n?{...E,[l]:u}:E))},{trigger:he,isMutating:pe}=b(["recal-collection"],async(e,{arg:n})=>we(n,o.id)),{trigger:xe,isMutating:ye}=b(["send-collection"],async(e,{arg:n})=>Ee(n,o.id)),ve=async()=>{const e=(r==null?void 0:r.map(s=>({cashCollectionDeviceTypeId:s.id,sumCoin:Number(s.sumCoinDeviceType),sumPaper:Number(s.sumPaperDeviceType)})))||[],n=(m==null?void 0:m.map(s=>({cashCollectionDeviceId:s.id,tookMoneyTime:s.tookMoneyTime})))||[],l=await he({cashCollectionDeviceData:n,cashCollectionDeviceTypeData:e});l&&(x(l.cashCollectionDeviceType),y(l.cashCollectionDevice),C(l))},Ce=async()=>{const e=(r==null?void 0:r.map(s=>({cashCollectionDeviceTypeId:s.id,sumCoin:Number(s.sumCoinDeviceType),sumPaper:Number(s.sumPaperDeviceType)})))||[],n=(m==null?void 0:m.map(s=>({cashCollectionDeviceId:s.id,tookMoneyTime:s.tookMoneyTime})))||[],l=await xe({cashCollectionDeviceData:n,cashCollectionDeviceTypeData:e});l&&(x(l.cashCollectionDeviceType),y(l.cashCollectionDevice),C(l),T("/finance/collection"))},De=async()=>{await te()&&T("/finance/collection")},P=[{label:"Тип",key:"typeName"},{label:"Купюры",key:"sumPaperDeviceType",render:(e,n)=>{var l;return e.key==="total"?"":t.jsx(_,{type:"number",label:"00,00",value:e.sumPaperDeviceType,changeValue:s=>n(e.id,"sumPaperDeviceType",s.target.value),disabled:((l=c.state)==null?void 0:l.status)===a("tables.SENT")})}},{label:"Монеты",key:"sumCoinDeviceType",render:(e,n)=>{var l;return e.key==="total"?"":t.jsx(_,{type:"number",label:"00,00",value:e.sumCoinDeviceType,changeValue:s=>n(e.id,"sumCoinDeviceType",s.target.value),disabled:((l=c.state)==null?void 0:l.status)===a("tables.SENT")})}},{label:"Сумма всего",key:"sumFactDeviceType",type:"number"},{label:"Недостача",key:"shortageDeviceType",type:"number"},{label:"Безналичная оплата",key:"virtualSumDeviceType",type:"number"}];return t.jsxs("div",{className:"space-y-6",children:[((q=c==null?void 0:c.state)==null?void 0:q.status)===a("tables.SENT")||((L=c==null?void 0:c.state)==null?void 0:L.status)===a("tables.SAVED")?t.jsx(t.Fragment,{}):t.jsxs("form",{className:"space-y-6",onSubmit:X(ne),children:[t.jsx("div",{className:"flex space-x-4",children:t.jsx(Fe,{title:a("finance.start")+"*",value:p.cashCollectionDate?A(p.cashCollectionDate):null,changeValue:e=>O("cashCollectionDate",e?e.format("YYYY-MM-DDTHH:mm"):""),error:!!g.cashCollectionDate,helperText:((V=g.cashCollectionDate)==null?void 0:V.message)||"",...M("cashCollectionDate",{required:"Cash Collection Date is required"}),classname:"w-64"})}),t.jsx(Me,{title:a("finance.carWash"),options:G,classname:"w-64",...M("posId",{required:"Pos ID is required",validate:e=>e!==0||"Pos ID is required"}),value:p.posId,onChange:e=>O("posId",e),error:!!g.posId,helperText:(B=g.posId)==null?void 0:B.message}),!ie&&t.jsx("div",{className:"flex justify-between",children:t.jsx(v,{title:a("finance.form"),isLoading:I,form:!0})})]}),t.jsx("div",{className:"flex justify-end",children:o&&Object.keys(o).length>0&&t.jsx(v,{title:a("finance.add"),type:"outline",iconUp:f,iconDown:!f,handleClick:()=>ae(!f)})}),f&&o&&Object.keys(o).length>0&&t.jsxs(t.Fragment,{children:[t.jsxs(d,{title:"",column:{xs:1,sm:2,md:2,lg:3,xl:3,xxl:3},labelStyle:{fontWeight:500},contentStyle:{textAlign:"right",fontSize:"16px",fontWeight:"bold"},children:[t.jsx(d.Item,{label:a("finance.no"),children:o.id}),t.jsx(d.Item,{label:a("marketing.total"),children:`${o.sumFact||"00"} ₽`}),t.jsx(d.Item,{label:a("finance.cars"),children:o.countCar||0}),t.jsx(d.Item,{label:a("finance.cash"),children:`${o.virtualSum||"00"} ₽`}),t.jsx(d.Item,{label:a("finance.amt"),children:`${o.sumCard||"00"} ₽`}),t.jsx(d.Item,{label:a("finance.short"),children:`${o.shortage||"00"} ₽`}),t.jsx(d.Item,{label:a("marketing.avg"),children:`${o.averageCheck||"00"} ₽`})]}),t.jsx(Re,{})]}),t.jsx("div",{children:I?t.jsx(K,{columnCount:P.length}):r.length>0?t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"cursor-pointer bg-background03 w-6 h-6 rounded text-text01",onClick:()=>ce(!N),children:N?t.jsx(j,{icon:"chevron-up"}):t.jsx(j,{icon:"chevron-down"})}),t.jsx("div",{className:"text-2xl font-semibold text-text01",children:a("finance.cashColl")})]}),N&&t.jsx(Pe,{tableData:r.sort((e,n)=>e.id-n.id),columns:P,handleChange:de,showTotal:!0})]}):t.jsx(t.Fragment,{})}),t.jsx("div",{children:I?t.jsx(K,{columnCount:U.length}):r.length>0?t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"cursor-pointer bg-background03 w-6 h-6 rounded text-text01",onClick:()=>oe(!w),children:w?t.jsx(j,{icon:"chevron-up"}):t.jsx(j,{icon:"chevron-down"})}),t.jsx("div",{className:"text-2xl font-semibold text-text01",children:a("finance.collDev")})]}),w&&t.jsx(Oe,{data:m,columns:U,onEdit:ue,renderCell:(e,n)=>{var l;if(e.type==="date")if(le===n.id&&e.key==="tookMoneyTime"){const s=n[e.key]||"",u=s?s.slice(0,16):"";return t.jsx("input",{type:"datetime-local",value:u,className:"w-full px-3 py-1 rounded-md caret-primary02 text-black border outline-none border-primary02 border-opacity-30 hover:border-primary02",onChange:D=>me(D,n.deviceId,e.key),onBlur:()=>S(null),autoFocus:!0,onKeyDown:D=>D.key==="Enter"&&S(null),disabled:((l=c.state)==null?void 0:l.status)===a("tables.SENT")})}else return A(n[e.key]).format("DD.MM.YYYY HH:mm:ss")||"-";return n[e.key]||"-"}})]}):t.jsx(t.Fragment,{})}),o&&Object.keys(o).length>0&&t.jsxs("div",{className:"flex space-x-3",children:[t.jsx(v,{type:"outline",title:a("organizations.cancel"),handleClick:()=>T("/finance/collection")}),((H=c.state)==null?void 0:H.status)!==a("tables.SENT")&&t.jsx(v,{type:"outline",title:a("finance.recal"),isLoading:pe,form:!0,handleClick:ve}),((W=c.state)==null?void 0:W.status)!==a("tables.SENT")&&t.jsx(v,{title:a("finance.recalSend"),isLoading:ye,form:!0,handleClick:Ce}),(($=c.state)==null?void 0:$.status)===a("tables.SENT")&&t.jsx(v,{title:a("finance.refund"),isLoading:se,handleClick:De})]})]})};export{Be as default};
