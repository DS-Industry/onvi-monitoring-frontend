import{d as re,q as ie,f as oe,r as m,v as k,cF as le,cG as ce,y as W,z as j,dV as de,dW as ue,dX as me,j as a,aB as he,aC as ge,B as c,aA as F,c7 as xe,aq as pe,D as ye,aM as fe,G as be,H as ke,a$ as O,K as v}from"./index-C24s9YLx.js";import{g as je}from"./index-Dx68t6LI.js";import{A as ve,a as Ie}from"./ArrowDown-C7pCZcds.js";import{P as Se}from"./NoPosition-Bk4hTKpm.js";import{T as we}from"./index-_QkmGTM0.js";const De=()=>{var C,D;const{t:n}=re(),A=ie(),I=oe(),[l,d]=m.useState([]),[E,h]=m.useState(!1),[V,R]=m.useState(!1),{data:g}=k(["get-organization"],()=>je({placementId:A}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:x}=k(["get-positions"],()=>le(),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:p}=k(["get-workers"],()=>ce({placementId:"*",hrPositionId:"*",organizationId:"*"}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),q=[{name:n("chemical.select"),value:0},...(g==null?void 0:g.map(e=>({name:e.name,value:e.id})))||[]],B=[...(p==null?void 0:p.map(e=>({key:String(e.props.id),title:e.props.name,value:e.props.id})))||[]],S=[{label:n("analysis.all"),value:"*",name:n("analysis.all")},...(x==null?void 0:x.map(e=>({label:e.props.name,value:e.props.id,name:e.props.name})))||[]],T={organizationId:0,billingMonth:"",hrPositionId:"*"},[o,H]=m.useState(T),{register:y,handleSubmit:$,errors:u,setValue:K}=W(o),{trigger:L,isMutating:w}=j(["calculate-salary"],async()=>{const e=await de({organizationId:o.organizationId,billingMonth:o.billingMonth,hrPositionId:o.hrPositionId});return R(!0),e}),{trigger:U,isMutating:G}=j(["create-salary"],async(e,{arg:s})=>ue(s)),f=(e,s)=>{const r=["organizationId","hrPositionId"].includes(e)?Number(s):s;H(i=>({...i,[e]:r})),K(e,s)},Y=(e,s,t)=>{d(r=>r==null?void 0:r.map(i=>i.id===e?{...i,[s]:t}:i))},_=async()=>{try{const e=await L();if(e)d(e.map((s,t)=>({...s,paymentDate:new Date,check:!1,countShifts:0,prize:0,fine:0,sum:0,id:t})));else throw new Error("Invalid update data.")}catch(e){console.error("Error during form submission: ",e)}},X=async()=>{for(let t=0;t<l.length;t++){const r=l[t],i=[];if(r.paymentDate||i.push("Дата выдачи"),(r.countShifts==null||r.countShifts<=0)&&i.push("Количество отработанных смен"),(r.sum==null||r.sum<=0)&&i.push("Выплачено ЗП"),i.length>0){O.error(`Строка ${t+1}: Заполните корректно поля: ${i.join(", ")}`);return}}const e=(l==null?void 0:l.map(t=>({hrWorkerId:t.hrWorkerId,paymentDate:t.paymentDate,billingMonth:t.billingMonth,countShifts:Number(t.countShifts),sum:Number(t.sum)})))||[];await U({payments:e})&&I(-1)},N=[{label:"",key:"check",render:(e,s)=>a.jsx("input",{type:"checkbox",checked:e.check,className:"w-[18px] h-[18px]",onChange:()=>s(e.id,"check",!e.check)})},{label:"ФИО",key:"name"},{label:"Должность",key:"hrPosition"},{label:"Месяц расчёта",key:"billingMonth",type:"date"},{label:"Оклад",key:"monthlySalary",type:"number"},{label:"Посменное начисление",key:"dailySalary",type:"number"},{label:"Процент",key:"percentageSalary",type:"number"},{label:"Количество отработанных смен",key:"countShifts",render:(e,s)=>a.jsx(v,{type:"number",placeholder:"00,00",value:e.countShifts,changeValue:t=>s(e.id,"countShifts",t.target.value)})},{label:"Выплачено ЗП",key:"sum",render:(e,s)=>a.jsx(v,{type:"number",placeholder:"00,00",value:e.sum,changeValue:t=>s(e.id,"sum",t.target.value)})},{label:"Дата выдачи",key:"paymentDate",render:(e,s)=>a.jsx(v,{type:"date",placeholder:"00,00",value:e.paymentDate,changeValue:t=>s(e.id,"paymentDate",t.target.value)})}],J=()=>{d(e=>e.filter(s=>!s.check))},P={organizationId:0,billingMonth:"",workerIds:[]},[b,z]=m.useState(P),{handleSubmit:Q,setValue:Z,reset:ee}=W(b),{trigger:ae,isMutating:te}=j(["adding-worker"],async()=>me({organizationId:o.organizationId,billingMonth:o.billingMonth,workerIds:b.workerIds})),se=e=>{const s=e.map(t=>Number(t));z(t=>({...t,workerIds:s})),Z("workerIds",s)},M=()=>{z(P),ee()},ne=async()=>{try{const e=await ae();if(e)e.length===0&&O.error(n("hr.noAdvance")),d(e.map((s,t)=>({...s,paymentDate:new Date,check:!1,countShifts:0,prize:0,fine:0,sum:0,id:t}))),M();else throw new Error("Invalid response from API")}catch(e){console.error("Error during form submission: ",e)}};return a.jsxs("div",{children:[a.jsxs(he,{isOpen:E,children:[a.jsxs("div",{className:"flex flex-row items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-lg font-semibold text-text01 text-center sm:text-left",children:n("roles.create")}),a.jsx(ge,{onClick:()=>{M(),h(!1)},className:"cursor-pointer text-text01"})]}),a.jsxs("form",{onSubmit:Q(ne),children:[a.jsx("div",{className:"flex flex-col space-y-4 text-text02",children:a.jsx(we,{dataSource:B,targetKeys:b.workerIds.map(String),onChange:se,render:e=>e.title,showSearch:!0,listStyle:{width:"calc(50% - 8px)",height:300},style:{width:"100%"}})}),a.jsxs("div",{className:"flex flex-wrap gap-3 mt-5",children:[a.jsx(c,{title:"Сбросить",handleClick:()=>h(!1),type:"outline"}),a.jsx(c,{title:"Сохранить",form:!0,isLoading:te})]})]})]}),a.jsxs("form",{className:"space-y-6",onSubmit:$(_),children:[a.jsxs("div",{className:"flex flex-col space-y-4 sm:flex-row sm:space-x-4 sm:space-y-0",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-text02",children:n("warehouse.organization")}),a.jsx(F,{className:"w-64 h-10",options:q.map(e=>({label:e.name,value:e.value})),value:o.organizationId,...y("organizationId",{required:"Organization Id is required",validate:e=>e!==0||"Organization Id is required"}),onChange:e=>f("organizationId",e),dropdownRender:e=>a.jsx("div",{style:{maxHeight:100,overflowY:"auto"},children:e}),status:u.organizationId?"error":""}),((C=u.organizationId)==null?void 0:C.message)&&a.jsx("div",{className:"text-xs text-errorFill mt-1",children:u.organizationId.message})]}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-text02",children:n("hr.billing")}),a.jsx(xe,{picker:"month",...y("billingMonth",{required:"Billing Month is required"}),value:o.billingMonth?pe(o.billingMonth):null,onChange:(e,s)=>f("billingMonth",s.toString()),className:"w-40 h-10",status:u.billingMonth?"error":"",placeholder:n("finance.selMon")}),((D=u.billingMonth)==null?void 0:D.message)&&a.jsx("div",{className:"text-xs text-errorFill mt-1",children:u.billingMonth.message})]}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-text02",children:n("routes.employees")}),a.jsx(F,{className:"w-64 h-10",options:S,value:o.hrPositionId,...y("hrPositionId"),onChange:e=>f("hrPositionId",e),dropdownRender:e=>a.jsx("div",{style:{maxHeight:100,overflowY:"auto"},children:e})})]})]}),a.jsxs("div",{className:"flex space-x-4",children:[a.jsx(c,{type:"outline",title:n("organizations.cancel"),handleClick:()=>I(-1)}),a.jsx(c,{title:n("finance.form"),isLoading:w,form:!0})]})]}),w?a.jsx(ye,{columnCount:N.length}):l.length>0?a.jsxs("div",{className:"mt-8 space-y-5 shadow-card rounded-2xl p-5",children:[a.jsxs("div",{className:"flex flex-wrap justify-between gap-2",children:[a.jsxs("div",{className:"flex space-x-4",children:[a.jsx(fe,{onClick:J,danger:!0,children:n("marketing.delete")}),a.jsx(c,{title:n("finance.addE"),type:"outline",iconPlus:!0,handleClick:()=>h(!0)})]}),a.jsxs("div",{className:"space-x-2",children:[a.jsx("button",{className:"px-2 py-1 bg-background07/50 rounded",onClick:()=>{const e=[...l].sort((s,t)=>s.id-t.id);d(e)},children:a.jsx("img",{src:ve,loading:"lazy",alt:"Arrow Up"})}),a.jsx("button",{className:"px-2 py-1 bg-background07/50 rounded",onClick:()=>{const e=[...l].sort((s,t)=>t.id-s.id);d(e)},children:a.jsx("img",{src:Ie,loading:"lazy",alt:"Arrow Down"})})]})]}),a.jsx(be,{data:l.map((e,s)=>{var t;return{...e,id:s,hrPosition:((t=S.find(r=>r.value===e.hrPositionId))==null?void 0:t.name)||""}}),columns:N,handleChange:Y}),a.jsx("div",{children:a.jsx("div",{className:"flex space-x-4",children:a.jsx(c,{title:n("organizations.save"),isLoading:G,handleClick:X})})})]}):V&&a.jsxs("div",{className:"flex flex-col justify-center items-center space-y-4",children:[a.jsx(ke,{title:n("marketing.nodata"),description:"",children:a.jsx("img",{src:Se,className:"mx-auto",loading:"lazy",alt:"Position Empty"})}),a.jsx(c,{title:n("finance.addE"),type:"outline",iconPlus:!0,handleClick:()=>h(!0)})]})]})};export{De as default};
