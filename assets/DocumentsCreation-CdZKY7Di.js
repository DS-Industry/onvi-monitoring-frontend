import{d as ie,bt as Ce,j as t,aC as Te,B as S,k as Qe,e as Me,r as x,f as Ge,_ as Pe,g as Ye,v as k,bu as Ae,z as ae,bv as ze,bw as He,a2 as Le,q as We,b3 as Fe,bk as _e,bx as Be,by as Ue,H as se,b9 as ne,bz as Ke,K as w,aP as $e,aq as Je,L as le,aA as re}from"./index-C24s9YLx.js";import{O as oe}from"./OverflowTable-BMnnkjZz.js";import{g as Xe}from"./index-Dx68t6LI.js";import{G as Ze}from"./GoodsAntTable-BYeoeGB0.js";const et=({isOpen:c,onClose:u,children:l,handleClick:O,classname:m})=>{const{t:I}=ie();return c?Ce.createPortal(t.jsxs("div",{className:"fixed inset-0 flex items-center justify-center z-50 px-4",children:[t.jsx("div",{className:"fixed inset-0 bg-black opacity-60",onClick:u}),t.jsxs("div",{className:`bg-white p-5 rounded-2xl shadow-lg z-10 w-full max-w-md sm:max-w-lg md:max-w-xl lg:max-w-2xl mx-auto max-h-[90vh] overflow-y-auto ${m}`,children:[t.jsxs("div",{className:"flex flex-row items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-lg sm:text-xl md:text-2xl font-semibold text-text01",children:I("warehouse.advanced")}),t.jsx("div",{className:"flex items-center gap-6",children:t.jsx(Te,{onClick:u,className:"cursor-pointer w-5 h-5 sm:w-6 sm:h-6"})})]}),l,t.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-5",children:[t.jsx(S,{title:I("organizations.cancel"),handleClick:u,type:"outline"}),t.jsx(S,{title:I("roles.addSel"),handleClick:O,iconPlus:!0})]})]})]}),document.body):null},lt=()=>{var Z,ee,te;const c=Qe(),{t:u}=ie(),l=Me(),O=l.state.wareHouseId,[m,I]=x.useState(O),[g,z]=x.useState(0),[H,L]=x.useState(0),[ue,R]=x.useState(""),[f,E]=x.useState(()=>new Date().toISOString().split("T")[0]),V=Ge(),W=Pe(),h=Ye(),[C,ce]=x.useState(""),[j,de]=x.useState({}),me=e=>{de(a=>({...a,[e]:!a[e]}))},{data:d,isLoading:T,isValidating:he}=k(["get-document-view"],()=>Ae(l.state.ownerId),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0});function F(e){return!!e&&"oldQuantity"in e&&"deviation"in e}function pe(e){return!!e&&"warehouseReceirId"in e}x.useEffect(()=>{var e,a,n,r;if(!T)if((d==null?void 0:d.document.props.status)==="SAVED"||(d==null?void 0:d.document.props.status)==="SENT"){I(d.document.props.warehouseId),R(d.document.props.name),E(new Date(d.document.props.carryingAt).toISOString().split("T")[0]),L(d.document.props.id),c==="MOVING"&&pe(d.details[0].props.metaData)&&z((e=d.details[0].props.metaData)==null?void 0:e.warehouseReceirId);const o=c==="INVENTORY"?d==null?void 0:d.details.map(s=>({id:s.props.id,check:!1,responsibleId:d.document.props.responsibleId,responsibleName:h.name,nomenclatureId:s.props.nomenclatureId,quantity:s.props.quantity,comment:s.props.comment||"",oldQuantity:F(s.props.metaData)?s.props.metaData.oldQuantity:0,deviation:F(s.props.metaData)?s.props.metaData.deviation:0})):d==null?void 0:d.details.map(s=>({id:s.props.id,check:!1,responsibleId:d.document.props.responsibleId,responsibleName:h.name,nomenclatureId:s.props.nomenclatureId,quantity:s.props.quantity,comment:s.props.comment||""}));y(o)}else{I(((a=l==null?void 0:l.state)==null?void 0:a.wareHouseId)||null),R(((n=l==null?void 0:l.state)==null?void 0:n.name)||"");const o=new Date(((r=l==null?void 0:l.state)==null?void 0:r.carryingAt)??"");E(isNaN(o.getTime())?null:o.toISOString().split("T")[0]),L(l==null?void 0:l.state.ownerId);const s=c==="INVENTORY"?[{id:l==null?void 0:l.state.ownerId,check:!1,responsibleId:h.id,responsibleName:h.name,nomenclatureId:0,quantity:0,comment:"",oldQuantity:0,deviation:0}]:[{id:l==null?void 0:l.state.ownerId,check:!1,responsibleId:h.id,responsibleName:h.name,nomenclatureId:0,quantity:0,comment:""}];y(s)}},[d,c,(Z=l==null?void 0:l.state)==null?void 0:Z.carryingAt,l==null?void 0:l.state.ownerId,(ee=l==null?void 0:l.state)==null?void 0:ee.name,(te=l==null?void 0:l.state)==null?void 0:te.wareHouseId,T,h.id,h.name]);const[_,q]=x.useState({warehouse:!1,warehouseRec:!1}),[D,B]=x.useState({}),[xe,Q]=x.useState(!1),fe=()=>{Q(!0)},{trigger:ye,isMutating:Ie}=ae(["save-document"],async(e,{arg:a})=>ze(a,H)),{trigger:ve,isMutating:we}=ae(["send-document"],async(e,{arg:a})=>He(a,H)),ge=Le(),U=We(),{data:M}=k(["get-org"],()=>Xe({placementId:U})),K=(M==null?void 0:M.map(e=>({name:e.name,value:e.id})))||[],{data:N}=k(K?["get-inventory"]:null,()=>Fe(K[0].value),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:G}=k(["get-warehouse"],()=>_e({posId:ge,placementId:U}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:b}=k(m!==null&&O!=="*"&&!isNaN(Number(m))?["get-inventory-items"]:null,()=>Be(Number(m)),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),v=(N==null?void 0:N.map(e=>({name:e.props.name,value:e.props.id})))||[],$=(G==null?void 0:G.map(e=>({name:e.props.name,value:e.props.id})))||[],P=(N==null?void 0:N.map(e=>({nomenclatureId:e.props.id,nomenclatureName:e.props.name,sku:e.props.sku})).filter(e=>e.nomenclatureName.toLowerCase().includes(C.toLowerCase())))||[],Y=(b==null?void 0:b.map(e=>({nomenclatureId:e.nomenclatureId,nomenclatureName:e.nomenclatureName,sku:e.quantity})).filter(e=>e.nomenclatureName.toLowerCase().includes(C.toLowerCase())))||[],Ne=(b==null?void 0:b.map(e=>({nomenclatureId:e.nomenclatureId,quantity:e.quantity})))||[],J=v.length>0?v[0].value:0,be=c==="INVENTORY"?[{id:1,check:!1,responsibleId:h.id,responsibleName:h.name,nomenclatureId:J,quantity:0,comment:"",oldQuantity:0,deviation:0}]:[{id:1,check:!1,responsibleId:h.id,responsibleName:h.name,nomenclatureId:J,quantity:0,comment:""}],[p,y]=x.useState(be),je=(e,a,n)=>{y(r=>r==null?void 0:r.map(o=>{var s;return o.id===e?"oldQuantity"in o&&"deviation"in o?{...o,[a]:n,oldQuantity:(s=Ne.find(i=>i.nomenclatureId===o.nomenclatureId))==null?void 0:s.quantity,deviation:a==="quantity"||a==="oldQuantity"?(a==="quantity"?Number(n):o.quantity)-(a==="oldQuantity"?Number(n):o.oldQuantity):o.deviation}:{...o,[a]:n}:o}))},ke=()=>{y(e=>{const a=e.length>0?Math.max(...e.map(s=>s.id)):0,n=new Set(e.map(s=>s.nomenclatureId)),r=v.find(s=>!n.has(s.value));if(!r)return e;const o={id:a+1,check:!1,responsibleId:h.id,responsibleName:h.name,nomenclatureId:r.value,quantity:0,comment:"",...c==="INVENTORY"&&{oldQuantity:0,deviation:0}};return[...e,o]})},Se=()=>{y(e=>e.filter(a=>!a.check))},Oe=()=>{y(e=>[...e].sort((a,n)=>a.id-n.id))},qe=()=>{y(e=>[...e].sort((a,n)=>n.id-a.id))},De=async()=>{let e=!1;const a={};p.forEach(i=>{a[i.id]={nomenclature:!1,quantity:!1}});const n={warehouse:!1,warehouseRec:!1};if((m===0||m==="*")&&(n.warehouse=!0,e=!0),c==="MOVING"&&m===g&&(n.warehouseRec=!0,n.warehouse=!0,e=!0),p==null||p.map(i=>{i.nomenclatureId===0&&(a[i.id].nomenclature=!0,e=!0),i.quantity<=0&&(a[i.id].quantity=!0,e=!0)}),c==="MOVING"&&m===g&&(q(i=>({...i,warehouseRec:!0,warehouse:!0})),e=!0),B(a),q(n),e)return;const r=p.filter(i=>i.check===!0),o=(r==null?void 0:r.map(i=>{const A={nomenclatureId:i.nomenclatureId,quantity:Number(i.quantity),comment:i.comment};return c==="MOVING"?{...A,metaData:{warehouseReceirId:g}}:c==="INVENTORY"&&"oldQuantity"in i&&"deviation"in i?{...A,metaData:{oldQuantity:Number(i.oldQuantity),deviation:Number(i.deviation)}}:A}))||[],s=await ye({warehouseId:m==null?0:Number(m),responsibleId:p[0].responsibleId,carryingAt:new Date(f===null?new Date().toISOString().split("T")[0]:f),details:o});W(new Date(f===null?new Date().toISOString().split("T")[0]:f)),s&&V("/warehouse/documents")},Re=async()=>{const e=p.map(()=>({nomenclature:!1,quantity:!1}));let a=!1;if((m===0||m==="*")&&(q(s=>({...s,warehouse:!0})),a=!0),p==null||p.map(s=>{s.nomenclatureId===0&&(e[s.id].nomenclature=!0,a=!0),s.quantity<=0&&(e[s.id].quantity=!0,a=!0)}),c==="MOVING"&&m===g&&(q(s=>({...s,warehouseRec:!0,warehouse:!0})),a=!0),B(e),a)return;const n=p.filter(s=>s.check===!0),r=(n==null?void 0:n.map(s=>{const i={nomenclatureId:s.nomenclatureId,quantity:Number(s.quantity),comment:s.comment};return c==="MOVING"?{...i,metaData:{warehouseReceirId:g}}:c==="INVENTORY"&&"oldQuantity"in s&&"deviation"in s?{...i,metaData:{oldQuantity:Number(s.oldQuantity),deviation:Number(s.deviation)}}:i}))||[],o=await ve({warehouseId:m==null?0:Number(m),responsibleId:p[0].responsibleId,carryingAt:new Date(f===null?new Date().toISOString().split("T")[0]:f),details:r});W(new Date(f===null?new Date().toISOString().split("T")[0]:f)),o&&V("/warehouse/documents")},Ee=c==="INVENTORY"?[{label:"",key:"check",render:(e,a)=>t.jsx("input",{type:"checkbox",checked:e.check,className:"w-[18px] h-[18px]",onChange:()=>a(e.id,"check",!e.check)})},{label:"№",key:"id"},{label:"Ответственный",key:"responsibleName"},{label:"Номенклатура",key:"nomenclatureId",render:(e,a)=>{var n;return t.jsx(re,{status:(n=D[e.id])!=null&&n.nomenclature?"error":"",value:e.nomenclatureId,placeholder:v.length===0?u("warehouse.noVal"):u("warehouse.notSel"),onChange:r=>a(e.id,"nomenclatureId",r),options:[{label:u("warehouse.notSel"),value:0},...v.map(r=>({label:r.name,value:r.value}))],className:"w-80 h-10",listHeight:160})}},{label:"Кол-во",key:"quantity",render:(e,a)=>{var n;return t.jsx(w,{type:"number",value:e.quantity,changeValue:r=>a(e.id,"quantity",r.target.value),error:((n=D[e.id])==null?void 0:n.quantity)||!1})}},{label:"Комментарий",key:"comment",render:(e,a)=>t.jsx(w,{value:e.comment,changeValue:n=>a(e.id,"comment",n.target.value)})},{label:"Кол-во учет",key:"oldQuantity",render:(e,a)=>t.jsx(w,{type:"number",value:e.oldQuantity,changeValue:n=>a(e.id,"oldQuantity",n.target.value),disabled:!0})},{label:"Отклонение",key:"deviation",render:(e,a)=>t.jsx(w,{type:"number",value:e.deviation,changeValue:n=>a(e.id,"deviation",n.target.value),disabled:!0})}]:[{label:"",key:"check",render:(e,a)=>t.jsx("input",{type:"checkbox",checked:e.check,className:"w-[18px] h-[18px]",onChange:()=>a(e.id,"check",!e.check)})},{label:"№",key:"id"},{label:"Ответственный",key:"responsibleName"},{label:"Номенклатура",key:"nomenclatureId",render:(e,a)=>{var n;return t.jsx(re,{status:(n=D[e.id])!=null&&n.nomenclature?"error":"",value:e.nomenclatureId,placeholder:v.length===0?u("warehouse.noVal"):u("warehouse.notSel"),onChange:r=>a(e.id,"nomenclatureId",r),options:[{label:u("warehouse.notSel"),value:0},...v.map(r=>({label:r.name,value:r.value}))],className:"w-80 h-10",listHeight:160})}},{label:"Кол-во",key:"quantity",render:(e,a)=>{var n;return t.jsx(w,{type:"number",value:e.quantity,changeValue:r=>a(e.id,"quantity",r.target.value),error:((n=D[e.id])==null?void 0:n.quantity)||!1})}},{label:"Комментарий",key:"comment",render:(e,a)=>t.jsx(w,{value:e.comment,changeValue:n=>a(e.id,"comment",n.target.value)})}],X=[{label:"",key:"check",render:e=>t.jsx("input",{type:"checkbox",checked:!!j[e.nomenclatureId],className:"w-[18px] h-[18px]",onChange:()=>me(e.nomenclatureId)})},{label:"Код",key:"sku"},{label:"Наименование товара",key:"nomenclatureName"}],Ve=()=>{const e=c==="RECEIPT"?P:Y;!e||!j||(y(a=>{const n=new Set(a.map(o=>o.nomenclatureId)),r=e.filter(o=>(j==null?void 0:j[o.nomenclatureId])&&!n.has(o.nomenclatureId)).map(o=>({id:o.nomenclatureId,check:!0,responsibleId:h.id,responsibleName:h.name,nomenclatureId:o.nomenclatureId,quantity:0,comment:"",...c==="INVENTORY"&&{oldQuantity:0,deviation:0}}));return r.length===0?a:[...a,...r]}),Q(!1))};return t.jsx(t.Fragment,{children:t.jsxs("div",{children:[t.jsx(et,{isOpen:xe,onClose:()=>Q(!1),handleClick:Ve,children:t.jsxs("div",{className:"w-full max-w-md sm:max-w-lg md:max-w-xl lg:max-w-3xl xl:max-w-4xl h-full max-h-[90vh] overflow-y-auto flex flex-col space-y-5 p-4",children:[t.jsx("div",{className:"flex",children:t.jsx(Ue,{value:C,onChange:e=>ce(e),classname:"w-full sm:w-64",searchType:"outlined"})}),t.jsx("div",{className:"mt-4 overflow-x-auto",children:c==="RECEIPT"?P.length>0?t.jsx(oe,{tableData:P,columns:X}):t.jsx("div",{className:"flex flex-col justify-center items-center",children:t.jsx(se,{title:u("roles.invent"),description:"",children:t.jsx("img",{src:ne,className:"mx-auto",loading:"lazy",alt:"Inventory"})})}):Y.length>0?t.jsx(oe,{tableData:Y,columns:X}):t.jsx("div",{className:"flex flex-col justify-center items-center",children:t.jsx(se,{title:u("roles.invent"),description:"",children:t.jsx("img",{src:ne,className:"mx-auto",loading:"lazy",alt:"Inventory"})})})})]})}),T||he?t.jsx("div",{className:"mt-16",children:t.jsx(Ke.Input,{style:{width:"100%",height:"300px"},active:!0,block:!0})}):t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-col sm:flex-row gap-y-4 py-4",children:[t.jsxs("div",{className:"flex flex-wrap gap-4",children:[t.jsxs("div",{className:"flex",children:[t.jsxs("div",{className:"mr-10 text-text01 font-normal text-sm",children:[t.jsx("div",{children:u("warehouse.no")}),t.jsx("div",{children:u("warehouse.overhead")})]}),t.jsx(w,{type:"",value:ue,changeValue:e=>R(e.target.value),disabled:!0})]}),t.jsxs("div",{className:"flex",children:[t.jsx("div",{className:"flex mt-3 text-text01 font-normal text-sm mx-2",children:u("warehouse.from")}),t.jsx($e,{value:f?Je(f):null,changeValue:e=>E(e?e.format("YYYY-MM-DDTHH:mm"):"")})]})]}),t.jsxs("div",{className:"flex flex-col space-y-6",children:[t.jsxs("div",{className:"flex space-x-2",children:[t.jsx("div",{className:"flex items-center justify-start sm:justify-center sm:w-64 text-text01 font-normal text-sm",children:u(c==="MOVING"?"warehouse.warehouseSend":"warehouse.ware")}),t.jsx(le,{value:m,options:$,label:u("warehouse.enterWare"),classname:"w-48 sm:w-80",onChange:e=>I(e),error:_.warehouse})]}),c==="MOVING"&&t.jsxs("div",{className:"flex space-x-2",children:[t.jsx("div",{className:"flex items-center sm:justify-center sm:w-64 text-text01 font-normal text-sm",children:u("warehouse.warehouseRec")}),t.jsx(le,{value:g,options:$,label:u("warehouse.enterWare"),classname:"w-48 sm:w-80",onChange:e=>z(e),error:_.warehouseRec})]})]})]}),t.jsx(Ze,{tableData:p,columns:Ee,handleChange:je,addRow:ke,addProduct:fe,deleteRow:Se,sortAscending:Oe,sortDescending:qe}),t.jsxs("div",{className:"flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-3",children:[t.jsx(S,{type:"outline",title:u("organizations.cancel"),handleClick:()=>V("/warehouse/documents")}),t.jsx(S,{type:"outline",title:u("warehouse.saveDraft"),form:!0,isLoading:Ie,handleClick:De}),t.jsx(S,{title:u("warehouse.saveAccept"),form:!0,isLoading:we,handleClick:Re})]})]})]})})};export{lt as default};
