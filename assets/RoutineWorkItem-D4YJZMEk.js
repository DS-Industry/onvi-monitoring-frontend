import{r as c,aQ as W,aR as B,e as P,d as T,q as Y,f as _,v as I,w as G,aS as K,z as Q,aT as X,j as e,D as A,aq as J,aU as Z,T as S,aL as D,aF as ee,F,aV as se,aW as te,aX as ae,B as E,L as le,K as L,M as ie}from"./index-C24s9YLx.js";import{T as ne}from"./TipTapEditor-CzqFtJTa.js";import{L as b}from"./index-B-3ghycs.js";var re={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M553.1 509.1l-77.8 99.2-41.1-52.4a8 8 0 00-12.6 0l-99.8 127.2a7.98 7.98 0 006.3 12.9H696c6.7 0 10.4-7.7 6.3-12.9l-136.5-174a8.1 8.1 0 00-12.7 0zM360 442a40 40 0 1080 0 40 40 0 10-80 0zm494.6-153.4L639.4 73.4c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v832c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V311.3c0-8.5-3.4-16.7-9.4-22.7zM790.2 326H602V137.8L790.2 326zm1.8 562H232V136h302v216a42 42 0 0042 42h216v494z"}}]},name:"file-image",theme:"outlined"},de=function(i,o){return c.createElement(W,B({},i,{ref:o,icon:re}))},oe=c.forwardRef(de);const O=[{name:"Ниже нормы",value:"belowNormal"},{name:"Норма",value:"normal"},{name:"Выше нормы",value:"aboveNormal"}],ce=({type:d,value:i,onChange:o,location:m,t:p})=>{var j,f,v;switch(d){case"Text":return e.jsx(L,{type:"text",value:i,changeValue:s=>o(s.target.value||""),classname:"w-80",disabled:((j=m.state)==null?void 0:j.status)===p("tables.FINISHED")});case"Number":return e.jsx(L,{type:"number",value:i,changeValue:s=>{o(s.target.value)},classname:"w-80",disabled:((f=m.state)==null?void 0:f.status)===p("tables.FINISHED")});case"SelectList":return e.jsx(le,{value:i,options:O,onChange:s=>o(s),classname:"w-80",isDisabled:((v=m.state)==null?void 0:v.status)===p("tables.FINISHED")});case"Checkbox":return e.jsx("input",{type:"checkbox",checked:!!i,onChange:s=>o(s.target.checked),className:"w-5 h-5"});default:return e.jsx("div",{children:"Unsupported type"})}},pe=()=>{var y;const d=P(),{t:i}=T(),o=Y(),m=_(),[p,j]=c.useState({}),{data:f}=I(["get-pos",o],()=>G({placementId:o}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),v=(f==null?void 0:f.map(t=>({name:t.name,value:t.id})))||[],{data:s,isLoading:R,isValidating:k}=I(["get-tech-task"],()=>{var t;return K((t=d.state)==null?void 0:t.ownerId)},{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),x=c.useMemo(()=>(s==null?void 0:s.items)||[],[s]);c.useEffect(()=>{const t=x.reduce((l,a)=>(l[a.group]=!1,l),{});j(t)},[x]);const V=t=>{j(l=>({...l,[t]:!l[t]}))},z=c.useMemo(()=>x.reduce((t,l)=>(t[l.group]||(t[l.group]=[]),t[l.group].push(l),t[l.group].sort((a,r)=>a.id-r.id),t),{}),[x]),{trigger:H,isMutating:C}=Q(["create-tech-task"],async(t,{arg:l})=>{var a;return X((a=d.state)==null?void 0:a.ownerId,l,l.files)}),[g,N]=c.useState({});c.useEffect(()=>{(async()=>{if(x.length>0){const l=x.reduce((n,u)=>(n[u.id]=u.value??"",n),{});N(l);const a=await Promise.all(x.map(async n=>{if(n.image){const u="https://storage.yandexcloud.net/onvi-business/image/pos/"+(s==null?void 0:s.posId)+"/techTask/"+(s==null?void 0:s.id)+`/${n.id}/${n.image}`;return[n.id,u]}else return[n.id,null]})),r=Object.fromEntries(a);w(r)}})()},[x,s]);const M=(t,l)=>{N(a=>({...a,[t]:l}))},[h,w]=c.useState({}),U=t=>async l=>{const{file:a,onSuccess:r,onError:n}=l;try{if(a instanceof File)w(u=>({...u,[t]:a})),r==null||r("ok");else throw new Error("Invalid file type")}catch(u){n==null||n(u)}},q=t=>{w(l=>({...l,[t]:null}))},$=async()=>{const t=Object.entries(g).map(([a,r])=>({itemValueId:Number(a),value:r}));await H({valueData:t,files:Object.entries(h).filter(([,a])=>a instanceof File).map(([a,r])=>({itemValueId:Number(a),file:r}))})&&(ie(["get-tech-task"]),m(-1))};return e.jsx("div",{className:"mt-5",children:R||k?e.jsx(A,{columnCount:5}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-text02",children:i("routine.title")}),e.jsx("div",{className:"w-80 border border-[#1476E9]/25 rounded-md px-2 py-2",children:(s==null?void 0:s.name)||""})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-text02",children:i("finance.carWash")}),e.jsx("div",{className:"w-80 border border-[#1476E9]/25 rounded-md px-2 py-2",children:((y=v.find(t=>t.value===(s==null?void 0:s.posId)))==null?void 0:y.name)||""})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-text02",children:i("routine.type")}),e.jsx("div",{className:"w-80 border border-[#1476E9]/25 rounded-md px-2 py-2",children:i(`tables.${s==null?void 0:s.type}`)||""})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-text02",children:i("equipment.deadline")}),e.jsxs("div",{className:"w-32 border border-[#1476E9]/25 rounded-md px-2 py-2 flex items-center justify-between",children:[e.jsx("span",{children:J(s==null?void 0:s.endSpecifiedDate).format("DD.MM.YYYY")||""}),e.jsx(Z,{style:{color:"#000",fontSize:"16px"}})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-text02",children:i("equipment.resp")}),e.jsx("div",{className:"w-80 border border-[#1476E9]/25 rounded-md px-2 py-2",children:"-"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-text02",children:i("marketing.tags")}),s&&s.tags.length>0?e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[s.tags.slice(0,3).map(t=>e.jsx(S,{color:"orange",children:t.name},t.id)),s.tags.slice(3).length>0&&e.jsx(D,{title:s.tags.slice(3).map(t=>t.name).join(", "),children:e.jsxs(S,{color:"default",children:["+",s.tags.slice(3).length," more"]})})]}):e.jsx("div",{className:"h-5",children:"-"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold text-2xl text-text01",children:i("equipment.taskInfo")}),(s==null?void 0:s.items.length)===0&&e.jsx(ne,{value:s==null?void 0:s.markdownDescription}),s&&(s==null?void 0:s.items.length)>0&&e.jsx(b,{dataSource:Object.entries(z),renderItem:([t,l])=>e.jsx(b.Item,{className:"w-full border-none p-0",children:e.jsxs(ee,{className:"w-full border-none shadow-none",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4 cursor-pointer",onClick:()=>V(t),children:[e.jsx("div",{className:"text-lg font-semibold text-text01",children:i(`chemical.${t}`)}),e.jsx("div",{className:"cursor-pointer w-6 h-6 text-primary02_Hover flex justify-center items-center",children:p[t]?e.jsx(F,{icon:"chevron-up"}):e.jsx(F,{icon:"chevron-down"})})]}),p[t]&&e.jsx(b,{dataSource:l,renderItem:a=>{var r;return e.jsx(b.Item,{className:"w-full border-none",children:e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"flex flex-col gap-4 md:flex-row md:items-start md:justify-between w-full",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:space-x-40 gap-2 min-w-[250px] max-w-full",children:[e.jsxs("div",{className:"flex items-center gap-2 w-64",children:[e.jsx(se,{}),e.jsx("div",{className:"text-text01 break-words",children:a.title})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-text02",children:i("equipment.comment")}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{customRequest:U(a.id),showUploadList:!1,multiple:!1,accept:"image/*",disabled:d.state.status===i("tables.FINISHED"),children:e.jsx("button",{type:"button",className:"flex items-center justify-center",title:"Upload",children:e.jsx(oe,{className:"text-primary02",style:{fontSize:"20px",marginTop:"4px"}})})}),d.state.status===i("tables.FINISHED")?e.jsx("div",{children:a.type==="SelectList"?(r=O.find(n=>n.value===g[a.id]))==null?void 0:r.name:g[a.id]}):e.jsx(ce,{type:a.type,value:g[a.id],onChange:n=>M(a.id,n),location:d,t:i})]})]})]})}),h[a.id]&&e.jsx("div",{className:"flex flex-wrap gap-4 pt-4",children:e.jsxs("div",{className:"relative w-[100px] h-[100px] border rounded-md overflow-hidden group",children:[e.jsx("img",{src:h[a.id]instanceof File?URL.createObjectURL(h[a.id]):h[a.id],alt:"uploaded",className:"w-full h-full object-cover",loading:"lazy"}),e.jsx("button",{onClick:()=>q(a.id),className:"absolute top-1 right-1 bg-black bg-opacity-50 text-white rounded-full p-1 hover:bg-opacity-80 transition",children:e.jsx(ae,{style:{fontSize:"12px"}})})]})})]})})}})]})})})]}),d.state.status!==i("tables.FINISHED")&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mt-6",children:[e.jsx(E,{title:i("organizations.cancel"),type:"outline",handleClick:()=>{m(-1)}}),e.jsx(E,{title:i("routine.done"),isLoading:C,handleClick:$})]})]})})};export{pe as default};
