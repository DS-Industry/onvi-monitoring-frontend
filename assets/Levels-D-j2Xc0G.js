import{r as s,aQ as xe,aR as he,d as ge,e as ye,v as S,y as L,z as P,j as e,aB as R,aC as z,K as U,Q as H,B as p,bz as m,T as ve,aK as je,F as we,M as A,a$ as Ie}from"./index-C24s9YLx.js";import{E as Te}from"./ExpandedCard-Cy-y6nhx.js";import{j as Ne,k as Se,l as Be,m as Ee,n as Ce}from"./index-BZ4ih03c.js";import{T as be}from"./index-_QkmGTM0.js";import{L as B}from"./index-B-3ghycs.js";var ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880 310H732.4c13.6-21.4 21.6-46.8 21.6-74 0-76.1-61.9-138-138-138-41.4 0-78.7 18.4-104 47.4-25.3-29-62.6-47.4-104-47.4-76.1 0-138 61.9-138 138 0 27.2 7.9 52.6 21.6 74H144c-17.7 0-32 14.3-32 32v200c0 4.4 3.6 8 8 8h40v344c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V550h40c4.4 0 8-3.6 8-8V342c0-17.7-14.3-32-32-32zm-334-74c0-38.6 31.4-70 70-70s70 31.4 70 70-31.4 70-70 70h-70v-70zm-138-70c38.6 0 70 31.4 70 70v70h-70c-38.6 0-70-31.4-70-70s31.4-70 70-70zM180 482V378h298v104H180zm48 68h250v308H228V550zm568 308H546V550h250v308zm48-376H546V378h298v104z"}}]},name:"gift",theme:"outlined"},Me=function(r,v){return s.createElement(xe,he({},r,{ref:v,icon:ke}))},_e=s.forwardRef(Me);const Fe=f=>s.createElement("svg",{width:40,height:40,viewBox:"0 0 40 40",fill:"none",xmlns:"http://www.w3.org/2000/svg",...f},s.createElement("rect",{width:40,height:40,fill:"#F5F5F5"}),s.createElement("g",{clipPath:"url(#clip0_751_38745)"},s.createElement("rect",{width:1440,height:1329,transform:"translate(-312 -287)",fill:"white"}),s.createElement("g",{filter:"url(#filter0_d_751_38745)"},s.createElement("rect",{x:-32,y:-27,width:1128,height:724,rx:16,fill:"white"}),s.createElement("rect",{width:40,height:40,rx:20,fill:"#0B68E1"}),s.createElement("path",{d:"M20 10C14.48 10 10 14.48 10 20C10 25.52 14.48 30 20 30C25.52 30 30 25.52 30 20C30 14.48 25.52 10 20 10ZM20 13C21.66 13 23 14.34 23 16C23 17.66 21.66 19 20 19C18.34 19 17 17.66 17 16C17 14.34 18.34 13 20 13ZM20 27.2C17.5 27.2 15.29 25.92 14 23.98C14.03 21.99 18 20.9 20 20.9C21.99 20.9 25.97 21.99 26 23.98C24.71 25.92 22.5 27.2 20 27.2Z",fill:"white"}))),s.createElement("defs",null,s.createElement("filter",{id:"filter0_d_751_38745",x:-43,y:-36,width:1150,height:746,filterUnits:"userSpaceOnUse",colorInterpolationFilters:"sRGB"},s.createElement("feFlood",{floodOpacity:0,result:"BackgroundImageFix"}),s.createElement("feColorMatrix",{in:"SourceAlpha",type:"matrix",values:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0",result:"hardAlpha"}),s.createElement("feMorphology",{radius:2,operator:"erode",in:"SourceAlpha",result:"effect1_dropShadow_751_38745"}),s.createElement("feOffset",{dy:2}),s.createElement("feGaussianBlur",{stdDeviation:6.5}),s.createElement("feColorMatrix",{type:"matrix",values:"0 0 0 0 0.126082 0 0 0 0 0.158639 0 0 0 0 0.218327 0 0 0 0.12 0"}),s.createElement("feBlend",{mode:"normal",in2:"BackgroundImageFix",result:"effect1_dropShadow_751_38745"}),s.createElement("feBlend",{mode:"normal",in:"SourceGraphic",in2:"effect1_dropShadow_751_38745",result:"shape"})),s.createElement("clipPath",{id:"clip0_751_38745"},s.createElement("rect",{width:1440,height:1329,fill:"white",transform:"translate(-312 -287)"})))),{Text:D}=je,ze=({prevStep:f})=>{var F,O,V;const{t:r}=ge(),[v,x]=s.useState(!1),[G,h]=s.useState(!1),[E,q]=s.useState([]),[u,K]=s.useState(0),o=ye(),[$,Z]=s.useState(!0),Q=()=>{x(!0)},{data:C,isLoading:W,isValidating:Y}=S(["get-tiers",o.state.ownerId],()=>Ne({programId:o.state.ownerId}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0,onSuccess:()=>{Z(!1)}}),b=W||Y||$,{data:n,isLoading:J}=S(u!==0?["get-tier-by-id",u]:null,()=>Se(u),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:c}=S(["get-benefits"],()=>Be(),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),X=(c==null?void 0:c.map(t=>({key:String(t.props.id),title:t.props.name,value:t.props.id})))||[],ee=(c==null?void 0:c.map(t=>({name:t.props.name,benefitType:t.props.benefitType,value:t.props.id})))||[];s.useEffect(()=>{n!=null&&n.id&&j({loyaltyTierId:n.id,description:n.description,benefitIds:n.benefitIds})},[n]),s.useEffect(()=>{const t=C||[];if(t.length>0){const a=t.map(i=>({id:i.id,name:i.name,description:i.description,loyaltyProgramId:i.loyaltyProgramId,limitBenefit:i.limitBenefit,benefitIds:i.benefitIds}));q(a)}},[r,C]);const k={name:"",description:void 0,loyaltyProgramId:o.state.ownerId,limitBenefit:0},te={loyaltyTierId:u,description:"",benefitIds:[]},[l,M]=s.useState(k),[d,j]=s.useState(te),{register:w,handleSubmit:se,errors:g,setValue:ae,reset:ie}=L(l),{register:re,handleSubmit:ne,setValue:_}=L(d),{trigger:le,isMutating:oe}=P(["create-loyalty-tier"],async()=>Ee({name:l.name,description:l.description,loyaltyProgramId:l.loyaltyProgramId,limitBenefit:l.limitBenefit})),{trigger:ce,isMutating:de}=P(["update-loyalty-tier"],async()=>Ce({loyaltyTierId:d.loyaltyTierId,description:d.description,benefitIds:d.benefitIds})),I=(t,a)=>{const T=["limitBenefit"].includes(t)?Number(a):a;M(N=>({...N,[t]:T})),ae(t,a)},me=(t,a)=>{const T=["limitBenefit"].includes(t)?Number(a):a;j(N=>({...N,[t]:T})),_(t,a)},ue=t=>{const a=t.map(i=>Number(i));if(n&&a.length>n.limitBenefit){Ie.error(`You can only select up to ${n.limitBenefit} benefits.`);return}j(i=>({...i,benefitIds:a})),_("benefitIds",a)},y=()=>{M(k),ie()},pe=async()=>{try{if(await le())A(["get-tiers",o.state.ownerId]),y(),x(!1);else throw new Error("Invalid response from API")}catch(t){console.error("Error during form submission: ",t)}},fe=async()=>{try{if(await ce())A(["get-tiers",o.state.ownerId]),y(),h(!1);else throw new Error("Invalid response from API")}catch(t){console.error("Error during form submission: ",t)}};return e.jsxs("div",{children:[e.jsxs(R,{isOpen:v,children:[e.jsxs("div",{className:"flex flex-row items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-text01 text-center sm:text-left",children:r("marketing.addLevel")}),e.jsx(z,{onClick:()=>{y(),x(!1)},className:"cursor-pointer text-text01"})]}),e.jsxs("form",{onSubmit:se(pe),className:"space-y-4 text-text02",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(U,{title:r("equipment.name"),classname:"w-80",inputType:"secondary",value:l.name,changeValue:t=>I("name",t.target.value),error:!!g.name,...w("name",{required:"Name is required"}),helperText:((F=g.name)==null?void 0:F.message)||""}),e.jsx(H,{title:r("warehouse.desc"),classname:"w-80",inputType:"secondary",value:l.description,changeValue:t=>I("description",t.target.value),...w("description")}),e.jsx(U,{type:"number",title:r("marketing.maxNo"),label:r("marketing.enter"),inputType:"secondary",classname:"w-80",value:l.limitBenefit,changeValue:t=>I("limitBenefit",t.target.value),error:!!g.limitBenefit,...w("limitBenefit",{required:"limitBenefit is required"}),helperText:((O=g.limitBenefit)==null?void 0:O.message)||"",showIcon:!0,IconComponent:e.jsx("div",{className:"text-text02 text-lg",children:"₽"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 mt-5",children:[e.jsx(p,{title:"Сбросить",handleClick:()=>{y(),x(!1)},type:"outline"}),e.jsx(p,{title:"Сохранить",form:!0,isLoading:oe})]})]})]}),e.jsxs(R,{isOpen:G,children:[e.jsxs("div",{className:"flex flex-row items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-text01 text-center sm:text-left",children:((V=E.find(t=>t.id===u))==null?void 0:V.name)||""}),e.jsx(z,{onClick:()=>{h(!1)},className:"cursor-pointer text-text01"})]}),J?e.jsxs("div",{className:"w-full max-w-[540px] space-y-4 flex flex-col",children:[e.jsx(m.Input,{active:!0,style:{width:"100%",height:120}}),e.jsx(m.Input,{active:!0,style:{width:"100%",height:300}}),e.jsxs("div",{className:"flex gap-3 mt-5",children:[e.jsx(m.Button,{active:!0}),e.jsx(m.Button,{active:!0})]})]}):e.jsxs("form",{onSubmit:ne(fe),className:"space-y-4 text-text02",children:[e.jsxs("div",{className:"w-full max-w-[540px] space-y-4",children:[e.jsx("div",{className:"w-full",children:e.jsx(H,{title:r("warehouse.desc"),classname:"w-full",inputType:"secondary",value:d.description,changeValue:t=>me("description",t.target.value),...re("description")})}),e.jsx(be,{dataSource:X,targetKeys:d.benefitIds.map(String),onChange:ue,render:t=>t.title,showSearch:!0,listStyle:{width:"calc(50% - 8px)",height:300},style:{width:"100%"}})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 mt-5",children:[e.jsx(p,{title:"Сбросить",handleClick:()=>h(!1),type:"outline"}),e.jsx(p,{title:"Сохранить",form:!0,isLoading:de})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-text02",children:[e.jsx("div",{children:r("marketing.create")}),e.jsx("div",{children:r("marketing.toMan")})]}),b?e.jsx("div",{className:"flex flex-col space-y-4",children:e.jsx(m.Input,{active:!0,style:{height:150,width:"100%"}})}):E.sort((t,a)=>t.name.localeCompare(a.name)).map(t=>e.jsx(Te,{firstText:t.name,secondText:t.description||"",Component:Fe,handleClick:()=>{h(!0),K(t.id)},buttonText:r("marketing.updateLevel"),children:e.jsxs("div",{className:"pl-0 sm:pl-14 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-start gap-3",children:[e.jsx("span",{className:"text-base font-medium text-text01",children:r("marketing.limitBenefit")}),e.jsx(ve,{color:"red",children:t.limitBenefit})]}),b?e.jsx(m,{active:!0,paragraph:{rows:3},title:!1,className:"w-full max-w-[400px]"}):e.jsx(B,{itemLayout:"horizontal",dataSource:t.benefitIds.map(a=>ee.find(i=>i.value===a)).filter(a=>a!==void 0).sort((a,i)=>a.name.localeCompare(i.name)),renderItem:a=>e.jsx(B.Item,{children:e.jsx(B.Item.Meta,{avatar:e.jsx("div",{className:"h-10 w-5 flex items-center justify-center text-primary02 text-2xl",children:e.jsx(_e,{})}),title:e.jsx(D,{className:"font-medium text-text01",children:(a==null?void 0:a.name)||"—"}),description:e.jsx(D,{type:"secondary",className:"text-text02",children:r(`marketing.${a==null?void 0:a.benefitType}`)||"—"})})})})]})},t.id)),e.jsx("div",{className:"flex flex-col md:flex-row space-x-2",children:e.jsxs("div",{className:"flex space-x-2 items-center text-primary02 cursor-pointer",onClick:Q,children:[e.jsx(we,{icon:"plus"}),e.jsx("div",{children:r("marketing.addLevel")})]})}),o.state.ownerId===0&&e.jsx(p,{title:"Назад",handleClick:f})]})]})};export{ze as default};
