import{d as re,q as le,f as ie,r as h,v as S,cF as oe,cG as ce,y as W,z as j,cS as de,cT as ue,cU as he,j as a,aB as me,aC as pe,B as c,aA as F,c7 as ye,aq as ge,D as xe,aM as fe,G as be,H as ke,a$ as O,K as p}from"./index-C24s9YLx.js";import{g as Se}from"./index-Dx68t6LI.js";import{A as je,a as ve}from"./ArrowDown-C7pCZcds.js";import{P as Ie}from"./NoPosition-Bk4hTKpm.js";import{T as we}from"./index-_QkmGTM0.js";const De=()=>{var M,D;const{t:s}=re(),E=le(),v=ie(),[o,d]=h.useState([]),[V,m]=h.useState(!1),[A,R]=h.useState(!1),{data:y}=S(["get-organization"],()=>Se({placementId:E}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:g}=S(["get-positions"],()=>oe(),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),{data:x}=S(["get-workers"],()=>ce({placementId:"*",hrPositionId:"*",organizationId:"*"}),{revalidateOnFocus:!1,revalidateOnReconnect:!1,keepPreviousData:!0}),T=[{name:s("chemical.select"),value:0},...(y==null?void 0:y.map(e=>({name:e.name,value:e.id})))||[]],q=[...(x==null?void 0:x.map(e=>({key:String(e.props.id),title:e.props.name,value:e.props.id})))||[]],I=[{label:s("analysis.all"),value:"*",name:s("analysis.all")},...(g==null?void 0:g.map(e=>({label:e.props.name,value:e.props.id,name:e.props.name})))||[]],B={organizationId:0,billingMonth:"",hrPositionId:"*"},[i,H]=h.useState(B),{register:f,handleSubmit:U,errors:u,setValue:$}=W(i),{trigger:K,isMutating:w}=j(["calculate-salary"],async()=>{const e=await de({organizationId:i.organizationId,billingMonth:i.billingMonth,hrPositionId:i.hrPositionId});return R(!0),e}),{trigger:L,isMutating:G}=j(["create-salary"],async(e,{arg:n})=>ue(n)),b=(e,n)=>{const r=["organizationId","hrPositionId"].includes(e)?Number(n):n;H(l=>({...l,[e]:r})),$(e,n)},Y=(e,n,t)=>{d(r=>r==null?void 0:r.map(l=>l.id===e?{...l,[n]:t}:l))},_=async()=>{try{const e=await K();if(e)d(e.map((n,t)=>({...n,check:!1,paymentDate:new Date,countShifts:0,prize:0,fine:0,sum:0,id:t})));else throw new Error("Invalid update data.")}catch(e){console.error("Error during form submission: ",e)}},J=async()=>{for(let t=0;t<o.length;t++){const r=o[t],l=[];if(r.paymentDate||l.push("Дата выдачи"),(r.countShifts==null||r.countShifts<=0)&&l.push("Количество отработанных смен"),(r.prize==null||r.prize<=0)&&l.push("Премия"),(r.fine==null||r.fine<=0)&&l.push("Штраф"),l.length>0){O.error(`Строка ${t+1}: Заполните корректно поля: ${l.join(", ")}`);return}}const e=(o==null?void 0:o.map(t=>({hrWorkerId:t.hrWorkerId,paymentDate:t.paymentDate,billingMonth:t.billingMonth,countShifts:Number(t.countShifts),sum:t.monthlySalary+t.dailySalary*t.countShifts-t.prepaymentSum,prize:Number(t.prize),fine:Number(t.fine)})))||[];await L({payments:e})&&v(-1)},z=[{label:"",key:"check",render:(e,n)=>a.jsx("input",{type:"checkbox",checked:e.check,className:"w-[18px] h-[18px]",onChange:()=>n(e.id,"check",!e.check)})},{label:"ФИО",key:"name"},{label:"Должность",key:"hrPosition"},{label:"Месяц расчёта",key:"billingMonth",type:"date"},{label:"Оклад",key:"monthlySalary",type:"number"},{label:"Посменное начисление",key:"dailySalary",type:"number"},{label:"Процент",key:"percentageSalary",type:"number"},{label:"Выплачено аванс",key:"prepaymentSum",type:"number"},{label:"Количество отработанных смен аванс",key:"prepaymentCountShifts",type:"number"},{label:"Количество отработанных смен",key:"countShifts",render:(e,n)=>a.jsx(p,{type:"number",placeholder:"00,00",value:e.countShifts,changeValue:t=>n(e.id,"countShifts",t.target.value)})},{label:"Количество отработанных смен итог",key:"totalCountShifts",type:"number"},{label:"Выплачено ЗП",key:"sum",type:"number"},{label:"Премия",key:"prize",render:(e,n)=>a.jsx(p,{type:"number",placeholder:"00,00",value:e.prize,changeValue:t=>n(e.id,"prize",t.target.value)})},{label:"Штраф",key:"fine",render:(e,n)=>a.jsx(p,{type:"number",placeholder:"00,00",value:e.fine,changeValue:t=>n(e.id,"fine",t.target.value)})},{label:"Выплачено итог",key:"totalPayment",type:"number"},{label:"Дата выдачи",key:"paymentDate",render:(e,n)=>a.jsx(p,{type:"date",placeholder:"00,00",value:e.paymentDate,changeValue:t=>n(e.id,"paymentDate",t.target.value)})}],Q=()=>{d(e=>e.filter(n=>!n.check))},N={organizationId:0,billingMonth:"",workerIds:[]},[k,C]=h.useState(N),{handleSubmit:X,setValue:Z,reset:ee}=W(k),{trigger:ae,isMutating:te}=j(["adding-worker"],async()=>he({organizationId:i.organizationId,billingMonth:i.billingMonth,workerIds:k.workerIds})),ne=e=>{const n=e.map(t=>Number(t));C(t=>({...t,workerIds:n})),Z("workerIds",n)},P=()=>{C(N),ee()},se=async()=>{try{const e=await ae();if(e)e.length===0&&O.error(s("hr.noSalary")),d(e.map((n,t)=>({...n,paymentDate:new Date,check:!1,countShifts:0,prize:0,fine:0,sum:0,id:t}))),P();else throw new Error("Invalid response from API")}catch(e){console.error("Error during form submission: ",e)}};return a.jsxs("div",{children:[a.jsxs(me,{isOpen:V,children:[a.jsxs("div",{className:"flex flex-row items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-lg font-semibold text-text01 text-center sm:text-left",children:s("roles.create")}),a.jsx(pe,{onClick:()=>{P(),m(!1)},className:"cursor-pointer text-text01"})]}),a.jsxs("form",{onSubmit:X(se),children:[a.jsx("div",{className:"flex flex-col space-y-4 text-text02",children:a.jsx(we,{dataSource:q,targetKeys:k.workerIds.map(String),onChange:ne,render:e=>e.title,showSearch:!0,listStyle:{width:"calc(50% - 8px)",height:300},style:{width:"100%"}})}),a.jsxs("div",{className:"flex flex-wrap gap-3 mt-5",children:[a.jsx(c,{title:"Сбросить",handleClick:()=>m(!1),type:"outline"}),a.jsx(c,{title:"Сохранить",form:!0,isLoading:te})]})]})]}),a.jsxs("form",{className:"space-y-6",onSubmit:U(_),children:[a.jsxs("div",{className:"flex flex-col space-y-4 sm:flex-row sm:space-x-4 sm:space-y-0",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-text02",children:s("warehouse.organization")}),a.jsx(F,{className:"w-64 h-10",options:T.map(e=>({label:e.name,value:e.value})),value:i.organizationId,...f("organizationId",{required:"Organization Id is required",validate:e=>e!==0||"Organization Id is required"}),onChange:e=>b("organizationId",e),dropdownRender:e=>a.jsx("div",{style:{maxHeight:100,overflowY:"auto"},children:e}),status:u.organizationId?"error":""}),((M=u.organizationId)==null?void 0:M.message)&&a.jsx("div",{className:"text-xs text-errorFill mt-1",children:u.organizationId.message})]}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-text02",children:s("hr.billing")}),a.jsx(ye,{picker:"month",...f("billingMonth",{required:"Billing Month is required"}),value:i.billingMonth?ge(i.billingMonth):null,onChange:(e,n)=>b("billingMonth",n.toString()),className:"w-40 h-10",status:u.billingMonth?"error":"",placeholder:s("finance.selMon")}),((D=u.billingMonth)==null?void 0:D.message)&&a.jsx("div",{className:"text-xs text-errorFill mt-1",children:u.billingMonth.message})]}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm text-text02",children:s("routes.employees")}),a.jsx(F,{className:"w-64 h-10",options:I,value:i.hrPositionId,...f("hrPositionId"),onChange:e=>b("hrPositionId",e),dropdownRender:e=>a.jsx("div",{style:{maxHeight:100,overflowY:"auto"},children:e})})]})]}),a.jsxs("div",{className:"flex space-x-4",children:[a.jsx(c,{type:"outline",title:s("organizations.cancel"),handleClick:()=>v(-1)}),a.jsx(c,{title:s("finance.form"),isLoading:w,form:!0})]})]}),w?a.jsx(xe,{columnCount:z.length}):o.length>0?a.jsxs("div",{className:"mt-8 space-y-5 shadow-card rounded-2xl p-5",children:[a.jsxs("div",{className:"flex flex-wrap justify-between gap-2",children:[a.jsxs("div",{className:"flex space-x-4",children:[a.jsx(fe,{onClick:Q,danger:!0,children:s("marketing.delete")}),a.jsx(c,{title:s("finance.addE"),type:"outline",iconPlus:!0,handleClick:()=>m(!0)})]}),a.jsxs("div",{className:"space-x-2",children:[a.jsx("button",{className:"px-2 py-1 bg-background07/50 rounded",onClick:()=>{const e=[...o].sort((n,t)=>n.id-t.id);d(e)},children:a.jsx("img",{src:je,loading:"lazy",alt:"Arrow Up"})}),a.jsx("button",{className:"px-2 py-1 bg-background07/50 rounded",onClick:()=>{const e=[...o].sort((n,t)=>t.id-n.id);d(e)},children:a.jsx("img",{src:ve,loading:"lazy",alt:"Arrow Down"})})]})]}),a.jsx(be,{data:o.map((e,n)=>{var t;return{...e,id:n,hrPosition:((t=I.find(r=>r.value===e.hrPositionId))==null?void 0:t.name)||"",totalCountShifts:e.prepaymentCountShifts+e.countShifts,sum:e.monthlySalary+e.dailySalary*(e.prepaymentCountShifts+e.countShifts)-e.prepaymentSum+e.prize-e.fine,totalPayment:e.prepaymentSum+e.monthlySalary+e.dailySalary*(e.prepaymentCountShifts+e.countShifts)-e.prepaymentSum+e.prize-e.fine}}),columns:z,handleChange:Y}),a.jsx("div",{children:a.jsx("div",{className:"flex space-x-4",children:a.jsx(c,{title:s("organizations.save"),isLoading:G,handleClick:J})})})]}):A&&a.jsxs("div",{className:"flex flex-col justify-center items-center space-y-4",children:[a.jsx(ke,{title:s("marketing.nodata"),description:"",children:a.jsx("img",{src:Ie,className:"mx-auto",loading:"lazy",alt:"Position Empty"})}),a.jsx(c,{title:s("finance.addE"),type:"outline",iconPlus:!0,handleClick:()=>m(!0)})]})]})};export{De as default};
